"""Telegram handlers and game flow for the Mafia bot - Part 1."""

import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputFile
from telegram.ext import ContextTypes
from telegram.constants import ParseMode
from collections import defaultdict
import asyncio
import random
from typing import Optional

from config import (
    ROLES, DEATH_PHRASES, SAVED_PHRASES, MAFIA_PHRASES, 
    DISCUSSION_PHRASES, MORNING_PHRASES, NIGHT_PHRASES,
    POTATO_PHRASES, SPECIAL_EVENTS, GIF_PATHS
)
from game_state import mafia_game

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logging.getLogger('httpx').setLevel(logging.WARNING)
logger = logging.getLogger(__name__)


async def send_gif(context: ContextTypes.DEFAULT_TYPE, chat_id: int, gif_type: str, caption: str = None):
    """–í—ñ–¥–ø—Ä–∞–≤–∫–∞ GIF —Ñ–∞–π–ª—É"""
    try:
        gif_path = GIF_PATHS.get(gif_type)
        if gif_path and os.path.exists(gif_path):
            with open(gif_path, 'rb') as gif:
                await context.bot.send_animation(
                    chat_id=chat_id,
                    animation=gif,
                    caption=caption,
                    parse_mode=ParseMode.HTML
                )
        elif caption:
            await context.bot.send_message(
                chat_id=chat_id,
                text=caption,
                parse_mode=ParseMode.HTML
            )
    except Exception as e:
        logger.error(f"–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ GIF: {e}")
        if caption:
            await context.bot.send_message(
                chat_id=chat_id,
                text=caption,
                parse_mode=ParseMode.HTML
            )


async def check_dead_player_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ë–ª–æ–∫—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –º–µ—Ä—Ç–≤–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤"""
    if not update.message or not update.message.text:
        return
    
    chat_id = update.message.chat_id
    user_id = update.message.from_user.id
    
    if chat_id in mafia_game.games:
        game = mafia_game.games[chat_id]
        if game['started'] and user_id in game['players'] and not game['players'][user_id]['alive']:
            try:
                await update.message.delete()
                await context.bot.send_message(
                    chat_id=user_id,
                    text="üíÄ <b>–¢–ò –ú–ï–†–¢–í–ò–ô!</b>\n\n–ù–µ –º–æ–∂–µ—à –ø–∏—Å–∞—Ç–∏ –≤ —á–∞—Ç –¥–æ –∫—ñ–Ω—Ü—è –≥—Ä–∏.\nü§ê –î–æ—Ç—Ä–∏–º—É–π—Å—è –ø—Ä–∞–≤–∏–ª!",
                    parse_mode=ParseMode.HTML
                )
            except Exception as e:
                logger.error(f"–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–µ—Ä—Ç–≤–æ–≥–æ –≥—Ä–∞–≤—Ü—è: {e}")


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start - –ø–æ–∫–∞–∑—É—î –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é"""
    if update.message and update.message.chat.type != 'private':
        await update.message.reply_text(
            "üëã <b>–í—ñ—Ç–∞—é –≤ –≥—Ä—ñ –ú–ê–§–Ü–Ø!</b>\n\n"
            "üìù –©–æ–± –∫–µ—Ä—É–≤–∞—Ç–∏ –≥—Ä–æ—é, –Ω–∞–ø–∏—à—ñ—Ç—å –º–µ–Ω—ñ /start –≤ –æ—Å–æ–±–∏—Å—Ç–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö!\n"
            "üéÆ –ö–æ–º–∞–Ω–¥–∏ –≤ –≥—Ä—É–ø—ñ:\n"
            "   /newgame - —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –≥—Ä—É\n"
            "   /endgame - –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –≥—Ä—É\n"
            "   /status - —Å—Ç–∞—Ç—É—Å –≥—Ä–∏\n\n"
            "üí° <b>–í–∞–∂–ª–∏–≤–æ:</b> –°–ø–æ—á–∞—Ç–∫—É –Ω–∞–ø–∏—à—ñ—Ç—å –±–æ—Ç—É –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è /start!",
            parse_mode=ParseMode.HTML
        )
        return
    
    keyboard = [
        [InlineKeyboardButton("üìú –ü—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏", callback_data="menu_rules")],
        [InlineKeyboardButton("üéÆ –Ø–∫ –≥—Ä–∞—Ç–∏?", callback_data="menu_howto")],
        [InlineKeyboardButton("üë• –ü–µ—Ä—Å–æ–Ω–∞–∂—ñ", callback_data="menu_characters")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_text = """
üé≠ <b>–ú–ê–§–Ü–Ø - Telegram Bot</b> üé≠

–í—ñ—Ç–∞—é –≤ –∫–ª–∞—Å–∏—á–Ω—ñ–π –≥—Ä—ñ –ú–ê–§–Ü–Ø!

<b>‚≠ê –ì–æ–ª–æ–≤–Ω—ñ –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ:</b>
üåæ <b>–î–µ–º—è–Ω</b> - –ü—Ä–æ—Å—Ç–∏–π —Å–µ–ª—è–Ω–∏–Ω
üëë <b>–ö—ñ—à–∫–µ–ª—å</b> - –î–æ–Ω –º–∞—Ñ—ñ—ó (—ñ–º—É–Ω—ñ—Ç–µ—Ç)
üî´ <b>–Ü–≥–æ—Ä –†–æ–≥–∞–ª—å—Å—å–∫–∏–π</b> - –ú–∞—Ñ—ñ–æ–∑—ñ
üíâ <b>–§–µ–¥–æ—Ä—á–∞–∫</b> - –õ—ñ–∫–∞—Ä-—Ä—è—Ç—ñ–≤–Ω–∏–∫
üîç <b>–î–µ—Ç–µ–∫—Ç–∏–≤</b> - –®—É–∫–∞—á –ø—Ä–∞–≤–¥–∏ (+ 1 –∫—É–ª—è)

<b>üéØ –ú–µ—Ç–∞:</b>
üîµ –ú–∏—Ä–Ω—ñ - –∑–Ω–∏—â–∏—Ç–∏ –º–∞—Ñ—ñ—é
üî¥ –ú–∞—Ñ—ñ—è - –∑–Ω–∏—â–∏—Ç–∏ –º–∏—Ä–Ω–∏—Ö

<b>üé≤ –ù–æ–≤—ñ —Ñ—ñ—á—ñ:</b>
- ü§ñ –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –±–æ—Ç—ñ–≤ (1-10)
- ü•î –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –ø–æ–¥—ñ—ó (30% —à–∞–Ω—Å)
- üî´ –î–µ—Ç–µ–∫—Ç–∏–≤ –º–æ–∂–µ –≤–∏—Å—Ç—Ä—ñ–ª–∏—Ç–∏
- üé™ –†–∞–Ω–¥–æ–º–Ω—ñ –ø–µ—Ä–∫–∏ (5% —à–∞–Ω—Å)

–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–¥—ñ–ª –Ω–∏–∂—á–µ! üëá
"""
    
    if update.message:
        await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode=ParseMode.HTML)
    else:
        await update.callback_query.message.edit_text(welcome_text, reply_markup=reply_markup, parse_mode=ParseMode.HTML)


async def newgame_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /newgame - —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä–∏ –≤ –≥—Ä—É–ø—ñ"""
    if update.message.chat.type == 'private':
        await update.message.reply_text(
            "‚ö†Ô∏è –¶—è –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –≤ –≥—Ä—É–ø–æ–≤–æ–º—É —á–∞—Ç—ñ!",
            parse_mode=ParseMode.HTML
        )
        return
    
    chat_id = update.message.chat_id
    admin_id = update.message.from_user.id
    
    if chat_id in mafia_game.games and mafia_game.games[chat_id]['started']:
        await update.message.reply_text(
            "‚ö†Ô∏è <b>–ì—Ä–∞ –≤–∂–µ –π–¥–µ!</b>\n\n–ó–∞–≤–µ—Ä—à—ñ—Ç—å –ø–æ—Ç–æ—á–Ω—É –≥—Ä—É –∫–æ–º–∞–Ω–¥–æ—é /endgame",
            parse_mode=ParseMode.HTML
        )
        return
    
    game = mafia_game.create_game(chat_id, admin_id)
    
    # –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—É –ø–æ–¥—ñ—é
    event_text = ""
    if game['special_event']:
        event_info = SPECIAL_EVENTS[game['special_event']]
        event_text = f"\n\nüé≤ <b>–°–ü–ï–¶–Ü–ê–õ–¨–ù–ê –ü–û–î–Ü–Ø!</b>\n{event_info['emoji']} <b>{event_info['name']}</b>\n<i>{event_info['description']}</i>\n"
    
    announcement_keyboard = [
        [InlineKeyboardButton("‚ûï –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–Ø", callback_data="join_game")],
        [InlineKeyboardButton("ü§ñ –î–û–î–ê–¢–ò –ë–û–¢–Ü–í", callback_data="add_bots_menu")],
        [InlineKeyboardButton("üéØ –ü–û–ß–ê–¢–ò –ì–†–£", callback_data="start_game")],
        [InlineKeyboardButton("‚ùå –í–ò–ô–¢–ò", callback_data="leave_game")],
    ]
    
    announcement_text = f"""
üéÆ <b>‚îÅ‚îÅ‚îÅ –ù–û–í–ê –ì–†–ê –°–¢–í–û–†–ï–ù–ê! ‚îÅ‚îÅ‚îÅ</b> üéÆ

üé≠ <b>–ú–ê–§–Ü–Ø</b> –∑–∞–ø—Ä–æ—à—É—î –≥—Ä–∞–≤—Ü—ñ–≤!{event_text}

<b>üéØ –ü—Ä–∞–≤–∏–ª–∞:</b>
- –ú—ñ–Ω—ñ–º—É–º 5 —É—á–∞—Å–Ω–∏–∫—ñ–≤ (–≥—Ä–∞–≤—Ü—ñ + –±–æ—Ç–∏)
- –ú–∞–∫—Å–∏–º—É–º 15 —É—á–∞—Å–Ω–∏–∫—ñ–≤
- –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –±–æ—Ç—ñ–≤ (1-10)
- –ì—Ä–∞ —Ç—Ä–∏–≤–∞—î –¥–æ –ø–µ—Ä–µ–º–æ–≥–∏

<b>üë• –ì—Ä–∞–≤—Ü—ñ (0/15):</b>
<i>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î...</i>

<b>ü§ñ –ë–æ—Ç—ñ–≤: 0</b>

<b>‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û:</b> –ù–∞–ø–∏—à—ñ—Ç—å /start –±–æ—Ç—É –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!

üëá <b>–ü–†–ò–Ñ–î–ù–£–ô–¢–ï–°–¨ –ó–ê–†–ê–ó!</b> üëá
"""
    
    msg = await update.message.reply_text(
        announcement_text,
        reply_markup=InlineKeyboardMarkup(announcement_keyboard),
        parse_mode=ParseMode.HTML
    )
    
    mafia_game.game_messages[chat_id] = msg.message_id

    """Telegram handlers - Part 2: Registration and Bots."""

import random
import asyncio
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.constants import ParseMode

from game_state import mafia_game
from config import SPECIAL_EVENTS

logger = logging.getLogger(__name__)


async def join_game_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ –≥—Ä–∏"""
    query = update.callback_query
    await query.answer()
    
    chat_id = query.message.chat_id
    user_id = query.from_user.id
    username = query.from_user.username or query.from_user.first_name
    
    if chat_id not in mafia_game.games:
        await query.answer("‚ö†Ô∏è –°—Ç–≤–æ—Ä—ñ—Ç—å –≥—Ä—É –∫–æ–º–∞–Ω–¥–æ—é /newgame!", show_alert=True)
        return
    
    game = mafia_game.games[chat_id]
    total_players = len(game['players']) + len(game['bots'])
    
    if total_players >= 15:
        await query.answer("‚ö†Ô∏è –ì—Ä–∞ –ø–æ–≤–Ω–∞! –ú–∞–∫—Å–∏–º—É–º 15 –≥—Ä–∞–≤—Ü—ñ–≤.", show_alert=True)
        return
    
    if mafia_game.add_player(chat_id, user_id, username):
        player_count = len(game['players'])
        
        try:
            welcome_msg = f"""
‚úÖ <b>–í–ò –í –ì–†–Ü!</b> üéâ

–í—ñ—Ç–∞—î–º–æ, <b>{username}</b>!

–í–∏ —É—Å–ø—ñ—à–Ω–æ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—è –¥–æ –≥—Ä–∏ –ú–ê–§–Ü–Ø!

üéÆ <b>–©–æ –¥–∞–ª—ñ?</b>
- –ß–µ–∫–∞–π—Ç–µ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –≥—Ä–∏
- –û—Ç—Ä–∏–º–∞—î—Ç–µ —Å–≤–æ—é —Ä–æ–ª—å –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- –ì—Ä–∞–π—Ç–µ —Ç–∞ –ø–µ—Ä–µ–º–∞–≥–∞–π—Ç–µ!

<b>üë• –ì—Ä–∞–≤—Ü—ñ–≤ –∑–∞—Ä–∞–∑:</b> {player_count}
<b>ü§ñ –ë–æ—Ç—ñ–≤:</b> {len(game['bots'])}
{'‚è≥ –ü–æ—Ç—Ä—ñ–±–Ω–æ —â–µ ' + str(5 - total_players - 1) + ' —É—á–∞—Å–Ω–∏–∫—ñ–≤' if total_players + 1 < 5 else '‚úÖ –ú–æ–∂–Ω–∞ –ø–æ—á–∏–Ω–∞—Ç–∏!'}

<i>–£–¥–∞—á—ñ –≤ –≥—Ä—ñ! üçÄ</i>
"""
            await context.bot.send_message(
                chat_id=user_id,
                text=welcome_msg,
                parse_mode=ParseMode.HTML
            )
        except Exception as e:
            logger.error(f"–ù–µ –º–æ–∂—É –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è {user_id}: {e}")
            del game['players'][user_id]
            await query.answer(
                "‚ö†Ô∏è –Ø –Ω–µ –º–æ–∂—É –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤–∞–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!\n"
                "–ù–∞–ø–∏—à—ñ—Ç—å –º–µ–Ω—ñ /start –≤ –æ—Å–æ–±–∏—Å—Ç–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö —Å–ø–æ—á–∞—Ç–∫—É!",
                show_alert=True
            )
            return
        
        await update_game_message(context, chat_id)
        await query.answer(f"‚úÖ {username} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è! üéâ")
    else:
        await query.answer("‚ö†Ô∏è –í–∏ –≤–∂–µ –≤ –≥—Ä—ñ!", show_alert=True)


async def add_bots_menu_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ú–µ–Ω—é –¥–æ–¥–∞–≤–∞–Ω–Ω—è –±–æ—Ç—ñ–≤"""
    query = update.callback_query
    await query.answer()
    
    chat_id = query.message.chat_id
    
    if chat_id not in mafia_game.games:
        await query.answer("‚ö†Ô∏è –°—Ç–≤–æ—Ä—ñ—Ç—å –≥—Ä—É –∫–æ–º–∞–Ω–¥–æ—é /newgame!", show_alert=True)
        return
    
    game = mafia_game.games[chat_id]
    total_players = len(game['players']) + len(game['bots'])
    available_slots = 15 - total_players
    
    if available_slots <= 0:
        await query.answer("‚ö†Ô∏è –ì—Ä–∞ –ø–æ–≤–Ω–∞! –ù–µ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –±–æ—Ç—ñ–≤.", show_alert=True)
        return
    
    keyboard = []
    for i in [1, 2, 3, 5, 10]:
        if i <= available_slots:
            keyboard.append([InlineKeyboardButton(
                f"ü§ñ –î–æ–¥–∞—Ç–∏ {i} –±–æ—Ç{'–∞' if i in [2, 3] else '—ñ–≤' if i > 3 else ''}",
                callback_data=f"add_bots_{i}"
            )])
    
    keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_game")])
    
    await query.edit_message_text(
        f"ü§ñ <b>–î–û–î–ê–¢–ò –ë–û–¢–Ü–í</b>\n\n"
        f"üë• –ó–∞—Ä–∞–∑ –≥—Ä–∞–≤—Ü—ñ–≤: {len(game['players'])}\n"
        f"ü§ñ –ó–∞—Ä–∞–∑ –±–æ—Ç—ñ–≤: {len(game['bots'])}\n"
        f"üìä –í—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å: {available_slots}\n\n"
        f"<b>–°–∫—ñ–ª—å–∫–∏ –±–æ—Ç—ñ–≤ –¥–æ–¥–∞—Ç–∏?</b>",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode=ParseMode.HTML
    )


async def add_bots_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–î–æ–¥–∞–≤–∞–Ω–Ω—è –±–æ—Ç—ñ–≤ –¥–æ –≥—Ä–∏"""
    query = update.callback_query
    await query.answer()
    
    data = query.data.split('_')
    count = int(data[2])
    chat_id = query.message.chat_id
    
    if chat_id not in mafia_game.games:
        await query.answer("‚ö†Ô∏è –ì—Ä–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!", show_alert=True)
        return
    
    added = mafia_game.add_bots(chat_id, count)
    
    if added > 0:
        await query.answer(f"‚úÖ –î–æ–¥–∞–Ω–æ {added} –±–æ—Ç{'–∞' if added in [2, 3] else '—ñ–≤'}!", show_alert=True)
        await update_game_message(context, chat_id)
        
        game = mafia_game.games[chat_id]
        bot_names = [b['username'] for b in game['bots'].values()]
        
        await context.bot.send_message(
            chat_id=chat_id,
            text=f"ü§ñ <b>–ë–æ—Ç–∏ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å –¥–æ –≥—Ä–∏!</b>\n\n"
                 f"{'üé≠ ' + ', '.join(bot_names)}\n\n"
                 f"<i>–¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –ø–æ—á–∏–Ω–∞—Ç–∏ –≥—Ä—É!</i>",
            parse_mode=ParseMode.HTML
        )
    else:
        await query.answer("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—å –¥–æ–¥–∞—Ç–∏ –±–æ—Ç—ñ–≤!", show_alert=True)


async def leave_game_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–∏—Ö—ñ–¥ –∑ –≥—Ä–∏"""
    query = update.callback_query
    await query.answer()
    
    chat_id = query.message.chat_id
    user_id = query.from_user.id
    username = query.from_user.username or query.from_user.first_name
    
    if chat_id not in mafia_game.games:
        await query.answer("‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω–∞ –≥—Ä–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!", show_alert=True)
        return
    
    if mafia_game.remove_player(chat_id, user_id):
        await update_game_message(context, chat_id)
        await query.answer(f"üëã {username} –≤–∏–π—à–æ–≤ –∑ –≥—Ä–∏")
    else:
        await query.answer("‚ö†Ô∏è –í–∏ –Ω–µ –≤ –≥—Ä—ñ –∞–±–æ –≥—Ä–∞ –≤–∂–µ –ø–æ—á–∞–ª–∞—Å—å!", show_alert=True)


async def update_game_message(context: ContextTypes.DEFAULT_TYPE, chat_id: int):
    """–û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≥—Ä—É"""
    if chat_id not in mafia_game.games or chat_id not in mafia_game.game_messages:
        return
    
    game = mafia_game.games[chat_id]
    all_players = mafia_game.get_all_players(chat_id)
    player_count = len(game['players'])
    bot_count = len(game['bots'])
    total_count = player_count + bot_count
    
    # –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—É –ø–æ–¥—ñ—é
    event_text = ""
    if game['special_event']:
        event_info = SPECIAL_EVENTS[game['special_event']]
        event_text = f"\n\nüé≤ <b>–°–ü–ï–¶–Ü–ê–õ–¨–ù–ê –ü–û–î–Ü–Ø!</b>\n{event_info['emoji']} <b>{event_info['name']}</b>\n<i>{event_info['description']}</i>"
    
    announcement_keyboard = [
        [InlineKeyboardButton("‚ûï –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–Ø", callback_data="join_game")],
        [InlineKeyboardButton("ü§ñ –î–û–î–ê–¢–ò –ë–û–¢–Ü–í", callback_data="add_bots_menu")],
        [InlineKeyboardButton("üéØ –ü–û–ß–ê–¢–ò –ì–†–£", callback_data="start_game")],
        [InlineKeyboardButton("‚ùå –í–ò–ô–¢–ò", callback_data="leave_game")],
    ]
    
    # –°–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤
    players_list = ""
    if game['players']:
        players_list += "<b>üë• –ì—Ä–∞–≤—Ü—ñ:</b>\n"
        for i, pinfo in enumerate(game['players'].values(), 1):
            players_list += f"   {i}. ‚úÖ {pinfo['username']}\n"
    
    # –°–ø–∏—Å–æ–∫ –±–æ—Ç—ñ–≤
    if game['bots']:
        players_list += f"\n<b>ü§ñ –ë–æ—Ç–∏ ({bot_count}):</b>\n"
        for i, binfo in enumerate(game['bots'].values(), 1):
            players_list += f"   {i}. ü§ñ {binfo['username']}\n"
    
    if not players_list:
        players_list = "<i>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î...</i>"
    
    updated_text = f"""
üéÆ <b>–ì–†–ê: –ú–ê–§–Ü–Ø</b> üéÆ{event_text}

<b>üìä –£—á–∞—Å–Ω–∏–∫—ñ–≤ ({total_count}/15):</b>
{players_list}

{'‚è≥ <b>–ü–æ—Ç—Ä—ñ–±–Ω–æ —â–µ ' + str(5 - total_count) + ' —É—á–∞—Å–Ω–∏–∫—ñ–≤ –¥–ª—è —Å—Ç–∞—Ä—Ç—É</b>' if total_count < 5 else 'üî• <b>–ú–æ–∂–Ω–∞ –ø–æ—á–∏–Ω–∞—Ç–∏ –≥—Ä—É!</b>'}

<b>‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û:</b> –ù–∞–ø–∏—à—ñ—Ç—å /start –±–æ—Ç—É –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!

üëá <b>–ü–†–ò–Ñ–î–ù–£–ô–¢–ï–°–¨!</b> üëá
"""
    
    try:
        await context.bot.edit_message_text(
            chat_id=chat_id,
            message_id=mafia_game.game_messages[chat_id],
            text=updated_text,
            reply_markup=InlineKeyboardMarkup(announcement_keyboard),
            parse_mode=ParseMode.HTML
        )
    except Exception as e:
        logger.error(f"–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: {e}")


async def back_to_game_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é –≥—Ä–∏"""
    query = update.callback_query
    await query.answer()
    
    chat_id = query.message.chat_id
    await update_game_message(context, chat_id)